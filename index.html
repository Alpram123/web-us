<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <title>Our Timeline | Pram & Caca</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      @keyframes subtleFloat {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-8px);
        }
      }
      @media (pointer: coarse) {
        .memory-item,
        .timeline-nav-btn {
          min-height: 44px;
        }
      }
      .floating {
        animation: subtleFloat 6s ease-in-out infinite;
      }
      .polaroid {
        background: white;
        padding: 0.5rem 0.5rem 2rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transform: rotate(-1deg);
        transition: all 0.3s ease;
      }
      .polaroid:hover {
        transform: rotate(1deg) scale(1.03);
      }
      .video-thumbnail {
        position: relative;
      }
      .video-thumbnail::after {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 2rem;
        opacity: 0.8;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }
      .memory-card {
        transition: all 0.3s ease;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.9) 0%,
          rgba(250, 250, 250, 0.95) 100%
        );
      }
      .memory-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
      }
      .timeline-marker {
        position: relative;
      }
      .timeline-marker::before {
        content: "";
        position: absolute;
        left: -15px;
        top: 50%;
        transform: translateY(-50%);
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #610bf5;
      }
      .timeline-nav-btn.active {
        background-color: #3800b0 !important;
        color: white !important;
        border-color: #3e13ce !important;
      }
      .language-switcher {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        gap: 0;
      }
      .lang-btn {
        padding: 5px 12px;
        border: 1px solid #e5e7eb;
        background-color: #f3f4f6;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        font-weight: 500;
      }
      .lang-btn:first-child {
        border-radius: 5px 0 0 5px;
      }
      .lang-btn:last-child {
        border-radius: 0 5px 5px 0;
      }
      .lang-btn:hover {
        background-color: #ffffff;
      }
      .lang-btn.active {
        background-color: #3e13ce;
        color: white;
        border-color: #3e13ce;
      }
      [data-translate] {
        transition: opacity 0.3s ease;
      }
      /* Dark mode styles */
      .dark {
        background: #1a202c;
        color: #e2e8f0;
      }
      .dark .timeline-nav-btn.active {
        background-color: #3c0ab1 !important;
        border-color: #3c0ab1 !important;
      }
      .dark .lang-btn {
        background-color: #2d3748 !important;
        border-color: #4a5568 !important;
        color: #e2e8f0 !important;
      }
      .dark .lang-btn.active {
        background-color: #3e13ce !important;
        color: white !important;
        border-color: #3e13ce !important;
      }
      .dark .lang-btn:hover {
        background-color: #4a5568 !important;
      }
      .dark .memory-card {
        background: linear-gradient(
          135deg,
          rgba(45, 55, 72, 0.9) 0%,
          rgba(26, 32, 44, 0.95) 100%
        );
        color: #e2e8f0;
      }
      .dark .polaroid {
        background: #2d3748;
        color: #e2e8f0;
      }
      .dark .text-gray-600 {
        color: #a0aec0;
      }
      .dark .bg-white {
        background-color: #2d3748;
        color: #e2e8f0;
        border-color: #4a5568;
      }
      .dark .bg-gray-100 {
        background-color: #2d3748;
      }
      .dark .bg-gradient-to-br {
        background: linear-gradient(to bottom right, #1a202c, #2d3748);
      }
      .dark .hide-scrollbar {
        background: linear-gradient(
          to bottom,
          #1a202c,
          rgba(26, 32, 44, 0.9),
          transparent
        );
      }
      .theme-toggle {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }
      .dark .theme-toggle {
        background: rgba(45, 55, 72, 0.8);
      }
      .theme-toggle:hover {
        transform: scale(1.1);
      }
      /* Upload Section Dark Mode */
      .dark #UPLOAD .memory-card {
        background: linear-gradient(
          135deg,
          rgba(45, 55, 72, 0.9) 0%,
          rgba(26, 32, 44, 0.95) 100%
        );
      }
      .dark .upload-container .bg-white {
        background-color: #2d3748 !important;
        border-color: #4a5568;
      }
      .dark .upload-container label {
        color: #e2e8f0 !important;
      }
      .dark #memoryCategory,
      .dark #memoryYear,
      .dark #memoryFile {
        background-color: #1a202c;
        border-color: #4a5568;
        color: #e2e8f0;
      }
      .dark #memoryCategory option {
        background-color: #2d3748;
        color: #e2e8f0;
      }
      .dark .upload-container button {
        background-color: #4f46e5 !important;
        border-color: #4f46e5 !important;
      }
      .dark .upload-container button:hover {
        background-color: #4338ca !important;
      }
      .dark #uploadedMemories .border {
        border-color: #4a5568 !important;
      }
      .dark #uploadedMemories .bg-red-500 {
        background-color: #dc2626 !important;
      }
      .dark #uploadedMemories .bg-red-500:hover {
        background-color: #b91c1c !important;
      }
      .dark #uploadedMemories p {
        color: #e2e8f0;
      }
      .dark #uploadedMemories strong {
        color: #f3f4f6;
      }
      /* Upload Form Styles */
      .upload-container .bg-white {
        transition: all 0.3s ease;
      }
      .upload-container button {
        transition: all 0.2s ease;
      }
      #memoryFile::-webkit-file-upload-button {
        visibility: hidden;
      }
      #memoryFile::before {
        content: "Pilih File";
        display: inline-block;
        background: #f3f4f6;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        padding: 6px 12px;
        outline: none;
        white-space: nowrap;
        cursor: pointer;
        font-weight: 500;
        font-size: 14px;
      }
      .dark #memoryFile::before {
        background: #2d3748;
        border-color: #4a5568;
        color: #e2e8f0;
      }
      /* Memory Item Styles */
      .memory-item {
        transition: transform 0.2s ease;
      }
      .memory-item:hover {
        transform: translateY(-2px);
      }
      /* Loading spinner */
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
        display: none;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body
    class="font-['Inter'] bg-gradient-to-br from-gray-50 to-gray-100 text-gray-800 min-h-screen"
  >
    <!-- Theme Toggle Button -->
    <div class="theme-toggle" id="themeToggle">
      <svg
        id="sunIcon"
        xmlns="http://www.w3.org/2000/svg"
        class="h-6 w-6 text-amber-500"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
        />
      </svg>
      <svg
        id="moonIcon"
        xmlns="http://www.w3.org/2000/svg"
        class="h-6 w-6 text-blue-400 hidden"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
        />
      </svg>
    </div>

    <div class="max-w-6xl mx-auto px-4 py-12">
      <!-- Header -->
      <header class="text-center mb-16">
        <div class="language-switcher">
          <button
            id="lang-en"
            class="lang-btn bg-gray-100 px-3 py-1 rounded-l-md border border-gray-300"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="14"
              viewBox="0 0 60 30"
            >
              <clipPath id="s"><path d="M0,0 v30 h60 v-30 z" /></clipPath>
              <clipPath id="t">
                <path d="M30,15 h30 v15 z v-30 h-30 z h-30 v30 z v-15 h30 z" />
              </clipPath>
              <g clip-path="url(#s)">
                <path d="M0,0 v30 h60 v-30 z" fill="#012169" />
                <path
                  d="M0,0 L60,30 M60,0 L0,30"
                  stroke="#fff"
                  stroke-width="6"
                />
                <path
                  d="M0,0 L60,30 M60,0 L0,30"
                  stroke="#C8102E"
                  stroke-width="4"
                  clip-path="url(#t)"
                />
                <path d="M30,0 v30 M0,15 h60" stroke="#fff" stroke-width="10" />
                <path
                  d="M30,0 v30 M0,15 h60"
                  stroke="#C8102E"
                  stroke-width="6"
                />
              </g>
            </svg>
          </button>
          <button
            id="lang-id"
            class="lang-btn bg-amber-100 px-3 py-1 rounded-r-md border border-gray-300"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="14"
              viewBox="0 0 3 2"
            >
              <rect width="3" height="1" y="0" fill="#ff0000" />
              <rect width="3" height="1" y="1" fill="#ffffff" />
            </svg>
          </button>
        </div>

        <div class="floating inline-block mb-6 relative">
          <div
            class="absolute -inset-2 rounded-full bg-gradient-to-r from-amber-200 to-rose-200 blur-sm opacity-75"
          ></div>
          <img
            src="kita3.jpg"
            class="w-24 h-24 rounded-full object-cover relative z-10 border-4 border-white shadow-lg"
          />
        </div>
        <h1
          class="text-4xl md:text-5xl font-bold mb-3 font-['Playfair_Display'] bg-clip-text text-transparent bg-gradient-to-r from-amber-500 to-rose-500"
          data-translate="welcome"
        >
          Our Shared Journey
        </h1>
        <p
          class="text-lg text-gray-600 max-w-2xl mx-auto"
          data-translate="description"
        >
          Every moment with you becomes a treasured memory
        </p>
      </header>

      <!-- Timeline Navigation -->
      <div
        class="flex overflow-x-auto pb-6 mb-10 hide-scrollbar sticky top-0 bg-gradient-to-b from-gray-50 via-gray-50/90 to-transparent z-10 pt-4"
      >
        <div class="flex space-x-3 mx-auto px-4" id="categoryButtons">
          <!-- Categories will be loaded dynamically -->
        </div>
      </div>

      <!-- Loading Spinner -->
      <div class="loader" id="loadingSpinner"></div>

      <!-- Memory Sections -->
      <main class="space-y-16" id="memorySections">
        <!-- Sections will be loaded dynamically -->
      </main>

      <!-- Upload Section (Hidden by default) -->
      <section id="UPLOAD" class="memory-section hidden">
        <div class="memory-card rounded-xl shadow-md overflow-hidden">
          <div class="p-6 pb-2">
            <h2
              class="text-2xl font-semibold mb-2 font-['Playfair_Display']"
              data-translate="upload"
            >
              Tambah Kenangan Baru
            </h2>
            <div class="upload-container space-y-4">
              <div class="bg-white p-4 rounded-lg shadow">
                <h3 class="text-lg font-semibold mb-3">Kelola Kategori</h3>
                <div class="flex gap-2 mb-4">
                  <input
                    type="text"
                    id="newCategoryName"
                    placeholder="Nama Kategori Baru"
                    class="flex-grow p-2 border rounded bg-white"
                    maxlength="20"
                  />
                  <button
                    id="addCategoryBtn"
                    class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded"
                  >
                    Tambah
                  </button>
                </div>

                <div class="bg-white p-4 rounded-lg shadow">
                  <h3 class="text-lg font-semibold mb-3">Daftar Kategori</h3>
                  <div id="categoryList" class="space-y-2">
                    <!-- Categories will be loaded dynamically -->
                  </div>
                </div>
              </div>

              <!-- Form Upload -->
              <div class="bg-white p-4 rounded-lg shadow">
                <div class="mb-4">
                  <label class="block text-gray-700 mb-2">Pilih Moment</label>
                  <select id="memoryCategory" class="w-full p-2 border rounded">
                    <!-- Options will be loaded dynamically -->
                  </select>
                </div>

                <div class="mb-4">
                  <label class="block text-gray-700 mb-2"
                    >Pilih File (Foto/Video)</label
                  >
                  <input
                    type="file"
                    id="memoryFile"
                    accept="image/*,video/*"
                    class="w-full p-2 border rounded"
                    multiple
                  />
                </div>

                <div class="mb-4">
                  <label class="block text-gray-700 mb-2">Tahun</label>
                  <input
                    type="number"
                    id="memoryYear"
                    value="2024"
                    min="2000"
                    max="2100"
                    class="w-full p-2 border rounded"
                  />
                </div>

                <button
                  onclick="uploadMemory()"
                  class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded"
                >
                  Upload Kenangan
                </button>
              </div>

              <!-- Backup/Restore -->
              <div class="bg-white p-4 rounded-lg shadow">
                <h3 class="text-lg font-semibold mb-3">Backup Data</h3>
                <div class="flex gap-2">
                  <button
                    onclick="backupMemories()"
                    class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded"
                  >
                    Backup ke File
                  </button>
                  <label
                    class="bg-purple-500 hover:bg-purple-600 text-white py-2 px-4 rounded cursor-pointer"
                  >
                    Restore dari File
                    <input
                      type="file"
                      accept=".json"
                      class="hidden"
                      onchange="restoreMemories(this.files[0])"
                    />
                  </label>
                </div>
              </div>

              <!-- Daftar File Terupload -->
              <div class="bg-white p-4 rounded-lg shadow">
                <h3 class="text-lg font-semibold mb-3">Kenangan Terupload</h3>
                <div
                  id="uploadedMemories"
                  class="grid grid-cols-1 md:grid-cols-2 gap-4"
                >
                  <!-- Items will be loaded dynamically -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <div class="flex flex-wrap justify-center gap-8 mt-8">
        <!-- Featured Image -->
        <div
          class="flex-1 min-w-[300px] max-w-md bg-white rounded-xl shadow-md overflow-hidden"
        >
          <div class="p-4">
            <h2
              class="text-xl font-semibold mb-3 font-['Playfair_Display'] text-center"
              data-translate="featured"
            >
              Featured Photo
            </h2>
            <div class="rounded-lg overflow-hidden">
              <img
                src="ondangan.jpg"
                class="w-full h-auto max-h-64 object-contain mx-auto"
              />
            </div>
          </div>
        </div>

        <div
          class="flex-1 min-w-[300px] max-w-md bg-white rounded-xl shadow-md overflow-hidden"
        >
          <div class="p-4">
            <h2
              class="text-xl font-semibold mb-3 font-['Playfair_Display'] text-center"
              data-translate="featured"
            >
              Featured Photo
            </h2>
            <div class="rounded-lg overflow-hidden">
              <img
                src="kita2.jpg"
                class="w-full h-auto max-h-64 object-contain mx-auto"
              />
            </div>
          </div>
        </div>

        <div
          class="flex-1 min-w-[300px] max-w-md bg-white rounded-xl shadow-md overflow-hidden"
        >
          <div class="p-4">
            <h2
              class="text-xl font-semibold mb-3 font-['Playfair_Display'] text-center"
              data-translate="featured"
            >
              Featured Photo
            </h2>
            <div class="rounded-lg overflow-hidden">
              <img
                src="wisuda1.jpg"
                class="w-full h-auto max-h-64 object-contain mx-auto"
              />
            </div>
          </div>
        </div>

        <!-- Featured Video -->
        <div
          class="flex-1 min-w-[300px] max-w-md bg-white rounded-xl shadow-md overflow-hidden"
        >
          <div class="p-4">
            <h2
              class="text-xl font-semibold mb-3 font-['Playfair_Display'] text-center"
              data-translate="featured"
            >
              Featured Video
            </h2>
            <div class="rounded-lg overflow-hidden">
              <video
                src="tiktokan.mp4"
                controls
                class="w-full h-auto max-h-64 object-contain mx-auto"
              ></video>
            </div>
          </div>
        </div>

        <div
          class="flex-1 min-w-[300px] max-w-md bg-white rounded-xl shadow-md overflow-hidden"
        >
          <div class="p-4">
            <h2
              class="text-xl font-semibold mb-3 font-['Playfair_Display'] text-center"
              data-translate="featured"
            >
              Featured Video
            </h2>
            <div class="rounded-lg overflow-hidden">
              <video
                src="cipanas.mp4"
                controls
                class="w-full h-auto max-h-64 object-contain mx-auto"
              ></video>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <footer class="mt-16 text-center text-gray-500 text-sm pb-8">
        <p>Created with ❤️ | Pram & Caca &COPY; 2025</p>
      </footer>
    </div>

    <script>
      // Global variables
      let memories = {};
      const MAX_PHOTO_SIZE = 5 * 1024 * 1024; // 5MB
      const MAX_VIDEO_SIZE = 15 * 1024 * 1024; // 15MB (reduced for mobile)
      const MAX_TOTAL_SIZE = 500 * 1024 * 1024; // 50MB (reduced for mobile)
      const MAX_ITEMS_PER_CATEGORY = 100;

      // Improved storage management functions
      function calculateCurrentStorageUsage() {
        return Object.values(memories)
          .flat()
          .reduce((sum, m) => sum + (m.size || 0), 0);
      }

      function clearOldestMemoriesIfNeeded(newFileSize) {
        const currentUsage = calculateCurrentStorageUsage();
        if (currentUsage + newFileSize <= MAX_TOTAL_SIZE) return false;

        // Sort all memories by date (oldest first)
        const allMemories = Object.entries(memories).flatMap(
          ([category, items]) =>
            items
              .map((item) => ({ ...item, category }))
              .sort((a, b) => (a.lastModified || 0) - (b.lastModified || 0))
        );

        let clearedSize = 0;
        const targetSize = currentUsage + newFileSize - MAX_TOTAL_SIZE;

        for (const memory of allMemories) {
          if (clearedSize >= targetSize) break;

          memories[memory.category] = memories[memory.category].filter(
            (m) => m.id !== memory.id
          );
          clearedSize += memory.size || 0;
        }

        return clearedSize > 0;
      }

      // Improved upload function
      async function uploadMemory() {
        const category = document.getElementById("memoryCategory").value;
        const year = document.getElementById("memoryYear").value;
        const files = document.getElementById("memoryFile").files;

        if (files.length === 0) {
          alert("Pilih file terlebih dahulu!");
          return;
        }

        // Validate files first
        for (let file of files) {
          const isImage = file.type.startsWith("image/");
          const isVideo = file.type.startsWith("video/");

          if (!isImage && !isVideo) {
            alert(
              `File ${file.name} harus berupa gambar (JPEG, PNG) atau video (MP4, MOV)`
            );
            return;
          }

          if (isImage && file.size > MAX_PHOTO_SIZE) {
            alert(
              `Ukuran foto ${file.name} (${formatFileSize(
                file.size
              )}) melebihi batas ${formatFileSize(MAX_PHOTO_SIZE)}`
            );
            return;
          }

          if (isVideo && file.size > MAX_VIDEO_SIZE) {
            alert(
              `Ukuran video ${file.name} (${formatFileSize(
                file.size
              )}) melebihi batas ${formatFileSize(MAX_VIDEO_SIZE)}`
            );
            return;
          }
        }

        // Calculate total size of new files
        const totalNewSize = Array.from(files).reduce(
          (sum, file) => sum + file.size,
          0
        );

        // Check storage space and clear old memories if needed
        const cleared = clearOldestMemoriesIfNeeded(totalNewSize);
        if (cleared) {
          console.log("Cleared old memories to make space");
        }

        const currentUsage = calculateCurrentStorageUsage();
        if (currentUsage + totalNewSize > MAX_TOTAL_SIZE) {
          alert(
            `Penyimpanan penuh! Total ${formatFileSize(
              currentUsage + totalNewSize
            )} melebihi batas ${formatFileSize(
              MAX_TOTAL_SIZE
            )}. Hapus beberapa kenangan lama.`
          );
          return;
        }

        // Process upload with loading spinner
        const spinner = document.getElementById("loadingSpinner");
        spinner.style.display = "block";

        try {
          // Process files sequentially to avoid memory issues
          for (let i = 0; i < files.length; i++) {
            const file = files[i];
            await processSingleFile(file, category, year);

            // Save after each file to prevent data loss
            if (!saveMemories()) {
              throw new Error("Gagal menyimpan ke penyimpanan lokal");
            }

            // Update UI after each file
            renderMemorySection(category);
            renderUploadedMemories();
          }

          alert(`${files.length} file berhasil diupload!`);
          document.getElementById("memoryFile").value = ""; // Reset form
        } catch (error) {
          console.error("Upload error:", error);
          alert(`Gagal upload: ${error.message}`);
        } finally {
          spinner.style.display = "none";
        }
      }

      // Process single file with Promise
      function processSingleFile(file, category, year) {
        return new Promise((resolve, reject) => {
          const isVideo = file.type.startsWith("video/");

          // Check if category exists, if not create it
          if (!memories[category]) {
            memories[category] = [];
          }

          // Check if category has too many items
          if (memories[category].length >= MAX_ITEMS_PER_CATEGORY) {
            // Remove oldest item in this category
            memories[category].shift();
          }

          if (isVideo) {
            // For videos, use Object URL
            const videoUrl = URL.createObjectURL(file);

            const memoryItem = {
              id: Date.now() + "-" + Math.random().toString(36).substr(2, 9),
              type: "video",
              src: videoUrl,
              year: year,
              category: category,
              name: file.name,
              size: file.size,
              lastModified: file.lastModified || Date.now(),
              isMobile: isMobileDevice(),
            };

            memories[category].push(memoryItem);
            resolve();
          } else {
            // For images, use FileReader
            const reader = new FileReader();

            reader.onload = function (e) {
              const memoryItem = {
                id: Date.now() + "-" + Math.random().toString(36).substr(2, 9),
                type: "image",
                src: e.target.result,
                year: year,
                category: category,
                name: file.name,
                size: file.size,
                lastModified: file.lastModified || Date.now(),
              };

              memories[category].push(memoryItem);
              resolve();
            };

            reader.onerror = function () {
              reject(new Error("Gagal membaca file"));
            };

            reader.readAsDataURL(file);
          }
        });
      }

      // Improved save function with size check
      function saveMemories() {
        try {
          // Stringify with replacer to handle circular references
          const data = JSON.stringify(memories, (key, value) => {
            // Skip the actual blob data to reduce size
            if (
              key === "src" &&
              typeof value === "string" &&
              value.startsWith("blob:")
            ) {
              return undefined;
            }
            return value;
          });

          // Check if data is too large
          if (new Blob([data]).size > MAX_TOTAL_SIZE) {
            alert("Data terlalu besar! Hapus beberapa kenangan lama.");
            return false;
          }

          localStorage.setItem("timelineMemories", data);
          return true;
        } catch (e) {
          if (e.name === "QuotaExceededError") {
            // Try to clear some space automatically
            const cleared = clearOldestMemoriesIfNeeded(0);
            if (cleared) {
              return saveMemories(); // Retry after clearing
            }
            alert("Penyimpanan penuh! Hapus beberapa kenangan lama.");
          } else {
            console.error("Error saving memories:", e);
          }
          return false;
        }
      }

      // Improved load function
      function loadMemories() {
        try {
          const savedMemories = localStorage.getItem("timelineMemories");

          if (!savedMemories) {
            // Initialize with default categories if empty
            memories = {};
            return;
          }

          const parsed = JSON.parse(savedMemories);

          // Validate and clean the loaded data
          memories = {};
          Object.keys(parsed).forEach((category) => {
            if (Array.isArray(parsed[category])) {
              // Filter out invalid items and add missing properties
              memories[category] = parsed[category]
                .filter(
                  (item) =>
                    item &&
                    item.id &&
                    (item.type === "image" || item.type === "video")
                )
                .map((item) => ({
                  ...item,
                  size: item.size || 0,
                  lastModified: item.lastModified || Date.now(),
                }));
            } else {
              memories[category] = [];
            }
          });

          // Ensure default categories exist
          const defaultCategories = [];
          defaultCategories.forEach((cat) => {
            if (!memories[cat]) {
              memories[cat] = [];
            }
          });

          // Clean up any Object URLs that might have been saved incorrectly
          Object.values(memories)
            .flat()
            .forEach((memory) => {
              if (
                memory.type === "video" &&
                memory.src &&
                memory.src.startsWith("blob:")
              ) {
                // Revoke the old URL if it exists
                try {
                  URL.revokeObjectURL(memory.src);
                } catch (e) {
                  console.warn("Failed to revoke object URL:", e);
                }
                // Remove the invalid reference
                memory.src = "";
              }
            });
        } catch (e) {
          console.error("Error loading memories:", e);
          // Fallback to empty memories
          memories = {};
        }
      }

      // Helper function to detect mobile
      function isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
          navigator.userAgent
        );
      }

      // Helper function to format file size
      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      // Function to open section
      function openSection(sectionId, event = null) {
        document.querySelectorAll(".memory-section").forEach((section) => {
          section.classList.add("hidden");
        });

        // Show selected section
        const section = document.getElementById(sectionId);
        if (section) {
          section.classList.remove("hidden");
        } else {
          // If section doesn't exist, show upload section
          document.getElementById("UPLOAD").classList.remove("hidden");
        }

        // Update active button
        const navButtons = document.querySelectorAll(".timeline-nav-btn");
        navButtons.forEach((btn) => {
          btn.classList.remove("active");
        });

        if (event) {
          event.currentTarget.classList.add("active");
        } else {
          // Find button matching the section
          const matchingBtn = Array.from(navButtons).find(
            (btn) => btn.dataset.category === sectionId
          );
          if (matchingBtn) {
            matchingBtn.classList.add("active");
          }
        }

        // Smooth scroll to section
        if (section) {
          section.scrollIntoView({
            behavior: "smooth",
            block: "start",
          });
        }
      }

      // Language translations
      const translations = {
        en: {
          welcome: "Our Journey Together",
          description: "Moments that became memories, captured in time",
          featured: "Featured Memory",
          upload: "Add New Memory",
        },
        id: {
          welcome: "Perjalanan Kami",
          description: "Momen yang menjadi kenangan, abadi dalam waktu",
          featured: "Memori Unggulan",
          upload: "Tambah Kenangan Baru",
        },
      };

      // Set language function
      function setLanguage(lang) {
        localStorage.setItem("preferredLang", lang);
        document.documentElement.lang = lang;

        // Update active language button
        document.querySelectorAll(".lang-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        document.getElementById(`lang-${lang}`).classList.add("active");

        // Update all translatable elements
        const elements = document.querySelectorAll("[data-translate]");
        elements.forEach((el) => {
          const key = el.getAttribute("data-translate");
          if (translations[lang][key]) {
            el.textContent = translations[lang][key];
          }
        });
      }

      // Theme functions
      function setTheme(theme) {
        if (theme === "dark") {
          document.documentElement.classList.add("dark");
          document.getElementById("sunIcon").classList.add("hidden");
          document.getElementById("moonIcon").classList.remove("hidden");
        } else {
          document.documentElement.classList.remove("dark");
          document.getElementById("sunIcon").classList.remove("hidden");
          document.getElementById("moonIcon").classList.add("hidden");
        }
        localStorage.setItem("theme", theme);
      }

      function toggleTheme() {
        const currentTheme = localStorage.getItem("theme") || "light";
        const newTheme = currentTheme === "light" ? "dark" : "light";
        setTheme(newTheme);
      }

      function deleteMemory(id, category) {
        if (!confirm("Apakah Anda yakin ingin menghapus kenangan ini?")) {
          return;
        }

        memories[category] = memories[category].filter((m) => m.id !== id);
        if (saveMemories()) {
          renderUploadedMemories();
          renderMemorySection(category);
        }
      }

      function backupMemories() {
        try {
          const data = JSON.stringify(memories);
          const blob = new Blob([data], { type: "application/json" });
          const url = URL.createObjectURL(blob);

          const a = document.createElement("a");
          a.href = url;
          a.download = `timeline-backup-${new Date()
            .toISOString()
            .slice(0, 10)}.json`;
          a.click();

          setTimeout(() => {
            URL.revokeObjectURL(url);
          }, 100);
        } catch (error) {
          alert(`Backup gagal: ${error.message}`);
          console.error(error);
        }
      }

      function restoreMemories(file) {
        if (!file) return;

        if (
          !confirm(
            "Restore backup akan mengganti semua data yang ada. Lanjutkan?"
          )
        ) {
          return;
        }

        const spinner = document.getElementById("loadingSpinner");
        spinner.style.display = "block";

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const backupData = JSON.parse(e.target.result);

            // Basic validation
            if (typeof backupData !== "object" || backupData === null) {
              throw new Error("Format backup tidak valid");
            }

            // Convert to proper format if needed
            const convertedData = {};
            Object.keys(backupData).forEach((category) => {
              convertedData[category] = Array.isArray(backupData[category])
                ? backupData[category]
                : [];
            });

            memories = convertedData;
            if (saveMemories()) {
              renderCategories();
              alert("Backup berhasil di-restore!");
            }
          } catch (e) {
            console.error("Error restoring backup:", e);
            alert("Gagal restore backup: " + e.message);
          } finally {
            spinner.style.display = "none";
          }
        };
        reader.readAsText(file);
      }

      function addCategory() {
        const newCategoryInput = document.getElementById("newCategoryName");
        const newCategoryName = newCategoryInput.value.trim();

        if (!newCategoryName) {
          alert("Masukkan nama kategori terlebih dahulu!");
          return;
        }

        if (newCategoryName.length > 20) {
          alert("Nama kategori terlalu panjang (maks 20 karakter)");
          return;
        }

        const newCategoryKey = newCategoryName
          .toUpperCase()
          .replace(/\s+/g, "_");

        if (memories[newCategoryKey]) {
          alert("Kategori sudah ada!");
          return;
        }

        // Add new category
        memories[newCategoryKey] = [];

        translations.en[
          `category_desc_${newCategoryKey.toLowerCase()}`
        ] = `Special ${newCategoryName.toLowerCase()} memories`;

        translations.id[
          `category_desc_${newCategoryKey.toLowerCase()}`
        ] = `Kenangan spesial ${newCategoryName.toLowerCase()}`;

        if (saveMemories()) {
          renderCategories();
          setLanguage(currentLang);
          // Reset input
          newCategoryInput.value = "";
          // Open upload section
          openSection("UPLOAD");
        }
      }

      function deleteCategory(category) {
        if (
          !confirm(
            `Hapus kategori ${getCategoryName(category)} dan semua isinya?`
          )
        ) {
          return;
        }

        // Delete category
        delete memories[category];
        if (saveMemories()) {
          renderCategories();

          // Open first available section or upload section
          const firstCategory = Object.keys(memories)[0];
          if (firstCategory) {
            openSection(firstCategory);
          } else {
            openSection("UPLOAD");
          }
        }
      }

      function isDefaultCategory(category) {
        const defaultCategories = [];
        return defaultCategories.includes(category);
      }

      function getCategoryName(category) {
        const defaultNames = {};

        if (defaultNames[category]) {
          return defaultNames[category];
        }

        return category
          .toLowerCase()
          .replace(/_/g, " ")
          .split(" ")
          .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
          .join(" ");
      }

      function renderCategories() {
        const categoryButtons = document.getElementById("categoryButtons");
        const categorySelect = document.getElementById("memoryCategory");
        const categoryList = document.getElementById("categoryList");
        const memorySections = document.getElementById("memorySections");

        // Clear all containers
        categoryButtons.innerHTML = "";
        categorySelect.innerHTML = "";
        categoryList.innerHTML = "";
        memorySections.innerHTML = "";

        // Sort categories alphabetically
        const sortedCategories = Object.keys(memories).sort();

        // Render navigation buttons
        sortedCategories.forEach((category) => {
          // Navigation button
          const button = document.createElement("button");
          button.onclick = (e) => openSection(category, e);
          button.className =
            "timeline-nav-btn px-5 py-2 rounded-full bg-white shadow-sm text-sm font-medium whitespace-nowrap hover:bg-white hover:text-blue-600 transition-all border border-gray-200";
          button.textContent = getCategoryName(category);
          button.dataset.category = category;
          categoryButtons.appendChild(button);

          // Dropdown option
          const option = document.createElement("option");
          option.value = category;
          option.textContent = getCategoryName(category);
          categorySelect.appendChild(option);

          // Category list item
          const categoryItem = document.createElement("div");
          categoryItem.className =
            "flex items-center justify-between p-2 border rounded";

          const categoryName = document.createElement("span");
          categoryName.textContent = getCategoryName(category);

          const deleteBtn = document.createElement("button");
          deleteBtn.className =
            "bg-red-500 hover:bg-red-600 text-white py-1 px-2 rounded text-xs";
          deleteBtn.textContent = "Hapus";
          deleteBtn.onclick = () => deleteCategory(category);

          // Disable delete for default categories
          if (isDefaultCategory(category)) {
            deleteBtn.disabled = true;
            deleteBtn.className += " opacity-50 cursor-not-allowed";
          }

          categoryItem.appendChild(categoryName);
          categoryItem.appendChild(deleteBtn);
          categoryList.appendChild(categoryItem);

          // Memory section
          const section = document.createElement("section");
          section.id = category;
          section.className = "memory-section hidden";

          section.innerHTML = `
            <div class="memory-card rounded-xl shadow-md overflow-hidden">
            <div class="p-6 pb-2">
                <h2 class="text-2xl font-semibold mb-2 font-['Playfair_Display']">${getCategoryName(
                  category
                )}</h2>
                <p class="text-gray-600 mb-6 timeline-marker" data-translate="category_desc_${category.toLowerCase()}">
                ${
                  translations["id"][
                    `category_desc_${category.toLowerCase()}`
                  ] || `Kenangan spesial ${getCategoryName(category)}`
                }
                </p>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4 p-4" id="${category.toLowerCase()}-grid"></div>
            </div>
        `;

          memorySections.appendChild(section);
        });

        // Add Upload button to navigation
        const uploadBtn = document.createElement("button");
        uploadBtn.onclick = (e) => openSection("UPLOAD", e);
        uploadBtn.className =
          "timeline-nav-btn px-5 py-2 rounded-full bg-white shadow-sm text-sm font-medium whitespace-nowrap hover:bg-white hover:text-blue-600 transition-all border border-gray-200";
        uploadBtn.textContent = "Upload";
        categoryButtons.appendChild(uploadBtn);

        // Render all memories
        renderAllMemories();
      }

      function renderAllMemories() {
        // Render each category
        Object.keys(memories).forEach((category) => {
          renderMemorySection(category);
        });
        renderUploadedMemories();
      }

      function renderMemorySection(category) {
        const grid = document.getElementById(`${category.toLowerCase()}-grid`);
        if (!grid || !memories[category]) return;

        grid.innerHTML = "";

        memories[category].forEach((memory) => {
          const item = document.createElement("div");
          item.className = "memory-item mx-2 mb-4";

          if (memory.type === "video") {
            item.innerHTML = `
        <div class="video-thumbnail relative">
          <video 
            src="${memory.src}" 
            controls
            class="w-full h-48 object-cover"
          ></video>
          <div class="text-center mt-2 text-sm text-gray-600">
            ${memory.year} • Video
          </div>
        </div>
      `;
          } else {
            item.innerHTML = `
        <div class="polaroid">
          <img 
            src="${memory.src}" 
            class="w-full h-48 object-cover"
            loading="lazy"
            alt="${memory.name}"
          >
          <div class="text-center mt-2 text-sm text-gray-600">
            ${memory.year} • Foto
          </div>
        </div>
      `;
          }

          grid.appendChild(item);
        });
      }

      function renderUploadedMemories() {
        const container = document.getElementById("uploadedMemories");
        container.innerHTML = "";

        Object.keys(memories).forEach((category) => {
          memories[category].forEach((memory) => {
            const item = document.createElement("div");
            item.className = "border rounded-lg p-3 flex flex-col memory-item";

            const preview = document.createElement(
              memory.type === "image" ? "img" : "video"
            );
            preview.src = memory.src;
            preview.className = "w-full h-32 object-cover rounded";
            if (memory.type === "video") {
              preview.controls = true;
            }

            const info = document.createElement("div");
            info.className = "mt-2 text-sm flex-grow";
            info.innerHTML = `
        <p><strong>Kategori:</strong> ${getCategoryName(memory.category)}</p>
        <p><strong>Tahun:</strong> ${memory.year}</p>
        <p><strong>Nama:</strong> ${memory.name || "Untitled"}</p>
        <p><strong>Ukuran:</strong> ${formatFileSize(memory.size)}</p>
      `;

            const deleteBtn = document.createElement("button");
            deleteBtn.className =
              "mt-2 bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded text-sm";
            deleteBtn.textContent = "Hapus";
            deleteBtn.onclick = () => deleteMemory(memory.id, memory.category);

            item.appendChild(preview);
            item.appendChild(info);
            item.appendChild(deleteBtn);

            container.appendChild(item);
          });
        });
      }

      // Initialize when DOM is loaded
      document.addEventListener("DOMContentLoaded", function () {
        // Initialize language
        const savedLang = localStorage.getItem("preferredLang") || "id";
        setLanguage(savedLang);

        // Language event listeners
        document
          .getElementById("lang-en")
          .addEventListener("click", () => setLanguage("en"));
        document
          .getElementById("lang-id")
          .addEventListener("click", () => setLanguage("id"));

        // Initialize theme
        const savedTheme = localStorage.getItem("theme") || "light";
        setTheme(savedTheme);

        // Theme toggle event
        document
          .getElementById("themeToggle")
          .addEventListener("click", toggleTheme);

        // Load memories with error handling
        try {
          loadMemories();
        } catch (e) {
          console.error("Failed to load memories:", e);
          memories = {};
        }

        // Initialize category management
        document
          .getElementById("addCategoryBtn")
          .addEventListener("click", addCategory);

        // Render everything
        renderCategories();
      });
    </script>
  </body>
</html>
